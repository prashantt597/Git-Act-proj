name: CD Pipeline

on:
  push:
    branches: [ main ]

env:
  KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
  RELEASE_NAME: killercoda-release
  CHART_PATH: ./helm-chart

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ env.KUBE_CONFIG_DATA }}" | base64 -d > $HOME/.kube/config
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      - name: Deploy Helm Chart
        run: |
          helm upgrade --install $RELEASE_NAME $CHART_PATH \
            --namespace default --create-namespace
